import{b9 as J,br as D,be as Q,an as X,bz as N,bx as q,cb as O,ap as x,ao as P,bT as C,b4 as Y,bW as j,bw as ee}from"./Circle.679b5c7b.js";import{j as te,L as z,q as se,B as W,d as $}from"./proj.6634b38d.js";var ie=class extends J{constructor(e){e=e||{},super({handleDownEvent:function(s){return t.handleDownEvent_(s)},handleDragEvent:function(s){return this.handleDragEvent_(s)},handleMoveEvent:function(s){return this.handleMoveEvent_(s)},handleUpEvent:function(s){return this.handleUpEvent_(s)}});var t=this;this.selection_=new D,this.handles_=new D,this.overlayLayer_=new Q({source:new X({features:this.handles_,useSpatialIndex:!1,wrapX:!1}),name:"Transform overlay",displayInLayerSwitcher:!1,style:function(s){return t.style[(s.get("handle")||"default")+(s.get("constraint")||"")+(s.get("option")||"")]}}),this.features_=e.features,typeof e.filter=="function"&&(this._filter=e.filter),this.layers_=e.layers?e.layers instanceof Array?e.layers:[e.layers]:null,this._handleEvent=e.condition||function(){return!0},this.addFn_=e.addCondition||function(){return!1},this.setPointRadius(e.pointRadius),this.set("translateFeature",e.translateFeature!==!1),this.set("translate",e.translate!==!1),this.set("translateBBox",e.translateBBox===!0),this.set("stretch",e.stretch!==!1),this.set("scale",e.scale!==!1),this.set("rotate",e.rotate!==!1),this.set("keepAspectRatio",e.keepAspectRatio||function(s){return s.originalEvent.shiftKey}),this.set("modifyCenter",e.modifyCenter||function(s){return s.originalEvent.metaKey||s.originalEvent.ctrlKey}),this.set("noFlip",e.noFlip||!1),this.set("selection",e.selection!==!1),this.set("hitTolerance",e.hitTolerance||0),this.set("enableRotatedTransform",e.enableRotatedTransform||!1),this.set("keepRectangle",e.keepRectangle||!1),this.set("buffer",e.buffer||0),this.on("propertychange",function(){this.drawSketch_()}),this.setDefaultStyle()}setMap(e){var t=this.getMap();if(t){var s=t.getTargetElement();t.removeLayer(this.overlayLayer_),this.previousCursor_&&s&&(s.style.cursor=this.previousCursor_),this.previousCursor_=void 0}super.setMap(e),this.overlayLayer_.setMap(e),e===null&&this.select(null),e!==null&&(this.isTouch=/touch/.test(e.getViewport().className),this.setDefaultStyle())}setActive(e){this.select(null),this.overlayLayer_&&this.overlayLayer_.setVisible(e),super.setActive(e)}setDefaultStyle(e){e=e||{};var t=e.pointStroke||new N({color:[255,0,0,1],width:1}),s=e.stroke||new N({color:[255,0,0,1],width:1,lineDash:[4,4]}),r=e.fill||new q({color:[255,0,0,.01]}),i=e.pointFill||new q({color:[255,255,255,.8]}),n=new O({fill:i,stroke:t,radius:this.isTouch?12:6,displacement:this.isTouch?[24,-24]:[12,-12],points:15});n.setDisplacement||(n.getAnchor()[0]=this.isTouch?-10:-5);var o=new O({fill:i,stroke:t,radius:this.isTouch?16:8,points:4,angle:Math.PI/4}),c=new O({fill:i,stroke:t,radius:this.isTouch?12:6,points:4,angle:Math.PI/4});function h(f,v,_){return[new ee({image:f,stroke:v,fill:_})]}this.style={default:h(o,s,r),translate:h(o,t,i),rotate:h(n,t,i),rotate0:h(o,t,i),scale:h(o,t,i),scale1:h(o,t,i),scale2:h(o,t,i),scale3:h(o,t,i),scalev:h(c,t,i),scaleh1:h(c,t,i),scalev2:h(c,t,i),scaleh3:h(c,t,i)},this.drawSketch_()}setStyle(e,t){if(!!t){t instanceof Array?this.style[e]=t:this.style[e]=[t];for(var s=0;s<this.style[e].length;s++){var r=this.style[e][s].getImage();r&&(e=="rotate"&&(r.getAnchor()[0]=-5),this.isTouch&&r.setScale(1.8));var i=this.style[e][s].getText();i&&(e=="rotate"&&i.setOffsetX(this.isTouch?14:7),this.isTouch&&i.setScale(1.8))}this.drawSketch_()}}getFeatureAtPixel_(e){var t=this;return this.getMap().forEachFeatureAtPixel(e,function(s,r){var i=!1;if(!r){if(s===t.bbox_)return t.get("translateBBox")?{feature:s,handle:"translate",constraint:"",option:""}:!1;if(t.handles_.forEach(function(o){o===s&&(i=!0)}),i)return{feature:s,handle:s.get("handle"),constraint:s.get("constraint"),option:s.get("option")}}if(!t.get("selection"))return t.selection_.getArray().some(function(o){return s===o})?{feature:s}:null;if(t._filter)return t._filter(s,r)?{feature:s}:null;if(t.layers_){for(var n=0;n<t.layers_.length;n++)if(t.layers_[n]===r)return{feature:s};return null}else return t.features_?(t.features_.forEach(function(o){o===s&&(i=!0)}),i?{feature:s}:null):{feature:s}},{hitTolerance:this.get("hitTolerance")})||{}}getGeometryRotateToZero_(e,t){var s=e.getGeometry(),r=this.getMap().getView().getRotation();if(r===0||!this.get("enableRotatedTransform"))return t?s.clone():s;var i=s.clone();return i.rotate(r*-1,this.getMap().getView().getCenter()),i}_isRectangle(e){if(this.get("keepRectangle")&&e.getType()==="Polygon"){var t=e.getCoordinates()[0];return t.length===5}return!1}drawSketch_(e){var t,s,r,i=this.selection_.item(0)&&this._isRectangle(this.selection_.item(0).getGeometry());if(this.overlayLayer_.getSource().clear(),!!this.selection_.getLength()){var n=this.getMap().getView().getRotation(),o=this.getGeometryRotateToZero_(this.selection_.item(0)).getExtent(),c;i&&(c=this.getGeometryRotateToZero_(this.selection_.item(0)).getCoordinates()[0].slice(0,4),c.unshift(c[3])),o=te(o,this.get("buffer")),this.selection_.forEach(function(F){var S=this.getGeometryRotateToZero_(F).getExtent();z(o,S)}.bind(this));var h=this.selection_.getLength()===1?this._pointRadius(this.selection_.item(0)):0;if(h&&!(h instanceof Array)&&(h=[h,h]),e===!0)this.ispt_||(this.overlayLayer_.getSource().addFeature(new x({geometry:new P(this.center_),handle:"rotate0"})),r=C(o),this.get("enableRotatedTransform")&&n!==0&&r.rotate(n,this.getMap().getView().getCenter()),s=this.bbox_=new x(r),this.overlayLayer_.getSource().addFeature(s));else{if(this.ispt_){var f=this.getMap().getPixelFromCoordinate([o[0],o[1]]);if(f){var v=h&&h[0]||10,_=h&&h[1]||10;o=se([this.getMap().getCoordinateFromPixel([f[0]-v,f[1]-_]),this.getMap().getCoordinateFromPixel([f[0]+v,f[1]+_])])}}r=i?new Y([c]):C(o),this.get("enableRotatedTransform")&&n!==0&&r.rotate(n,this.getMap().getView().getCenter()),s=this.bbox_=new x(r);var m=[],g=r.getCoordinates()[0];if(!this.ispt_||h){if(m.push(s),!this.iscircle_&&!this.ispt_&&this.get("stretch")&&this.get("scale"))for(t=0;t<g.length-1;t++)s=new x({geometry:new P([(g[t][0]+g[t+1][0])/2,(g[t][1]+g[t+1][1])/2]),handle:"scale",constraint:t%2?"h":"v",option:t}),m.push(s);if(this.get("scale"))for(t=0;t<g.length-1;t++)s=new x({geometry:new P(g[t]),handle:"scale",option:t}),m.push(s);this.get("translate")&&!this.get("translateFeature")&&(s=new x({geometry:new P([(g[0][0]+g[2][0])/2,(g[0][1]+g[2][1])/2]),handle:"translate"}),m.push(s))}!this.iscircle_&&this.get("rotate")&&(s=new x({geometry:new P(g[3]),handle:"rotate"}),m.push(s)),this.overlayLayer_.getSource().addFeatures(m)}}}select(e,t){if(!e){this.selection_&&(this.selection_.clear(),this.drawSketch_());return}if(!(!e.getGeometry||!e.getGeometry())){if(t)this.selection_.push(e);else{var s=this.selection_.getArray().indexOf(e);this.selection_.removeAt(s)}this.ispt_=this.selection_.getLength()===1?this.selection_.item(0).getGeometry().getType()=="Point":!1,this.iscircle_=this.selection_.getLength()===1?this.selection_.item(0).getGeometry().getType()=="Circle":!1,this.drawSketch_(),this.watchFeatures_(),this.dispatchEvent({type:"select",feature:e,features:this.selection_})}}setSelection(e){this.selection_.clear(),e.forEach(function(t){this.selection_.push(t)}.bind(this)),this.ispt_=this.selection_.getLength()===1?this.selection_.item(0).getGeometry().getType()=="Point":!1,this.iscircle_=this.selection_.getLength()===1?this.selection_.item(0).getGeometry().getType()=="Circle":!1,this.drawSketch_(),this.watchFeatures_(),this.dispatchEvent({type:"select",features:this.selection_})}watchFeatures_(){this._featureListeners&&this._featureListeners.forEach(function(e){j(e)}),this._featureListeners=[],this.selection_.forEach(function(e){this._featureListeners.push(e.on("change",function(){this.isUpdating_||this.drawSketch_()}.bind(this)))}.bind(this))}handleDownEvent_(e){if(!!this._handleEvent(e,this.selection_)){var t=this.getFeatureAtPixel_(e.pixel),s=t.feature;if(this.selection_.getLength()&&this.selection_.getArray().indexOf(s)>=0&&(this.ispt_&&this.get("translate")||this.get("translateFeature"))&&(t.handle="translate"),t.handle){this.mode_=t.handle,this.opt_=t.option,this.constraint_=t.constraint;var r=this.getMap().getView().getRotation();this.coordinate_=e.coordinate,this.pixel_=e.pixel,this.geoms_=[],this.rotatedGeoms_=[];for(var i=$(),n=$(),o=0,c;c=this.selection_.item(o);o++)if(this.geoms_.push(c.getGeometry().clone()),i=z(i,c.getGeometry().getExtent()),this.get("enableRotatedTransform")&&r!==0){var h=this.getGeometryRotateToZero_(c,!0);this.rotatedGeoms_.push(h),n=z(n,h.getExtent())}if(this.extent_=C(i).getCoordinates()[0],this.get("enableRotatedTransform")&&r!==0&&(this.rotatedExtent_=C(n).getCoordinates()[0]),this.mode_==="rotate"){this.center_=this.getCenter()||W(i);var f=e.map.getTargetElement();f.style.cursor=this.Cursors.rotate0,this.previousCursor_=f.style.cursor}else this.center_=W(i);return this.angle_=Math.atan2(this.center_[1]-e.coordinate[1],this.center_[0]-e.coordinate[0]),this.dispatchEvent({type:this.mode_+"start",feature:this.selection_.item(0),features:this.selection_,pixel:e.pixel,coordinate:e.coordinate}),!0}else if(this.get("selection")){if(s){this.addFn_(e)||this.selection_.clear();var v=this.selection_.getArray().indexOf(s);v<0?this.selection_.push(s):this.selection_.removeAt(v)}else this.selection_.clear();return this.ispt_=this.selection_.getLength()===1?this.selection_.item(0).getGeometry().getType()=="Point":!1,this.iscircle_=this.selection_.getLength()===1?this.selection_.item(0).getGeometry().getType()=="Circle":!1,this.drawSketch_(),this.watchFeatures_(),this.dispatchEvent({type:"select",feature:s,features:this.selection_,pixel:e.pixel,coordinate:e.coordinate}),!1}}}getCenter(){return this.get("center")}setCenter(e){return this.set("center",e)}handleDragEvent_(e){if(!!this._handleEvent(e,this.features_)){var t=this.getMap().getView().getRotation(),s,r,i,n,o=[this.coordinate_[0],this.coordinate_[1]],c=[e.coordinate[0],e.coordinate[1]];switch(this.isUpdating_=!0,this.mode_){case"rotate":{var h=Math.atan2(this.center_[1]-c[1],this.center_[0]-c[0]);if(!this.ispt)for(s=0,i;i=this.selection_.item(s);s++)n=this.geoms_[s].clone(),n.rotate(h-this.angle_,this.center_),n.getType()=="Circle"&&n.setCenterAndRadius(n.getCenter(),n.getRadius()),i.setGeometry(n);this.drawSketch_(!0),this.dispatchEvent({type:"rotating",feature:this.selection_.item(0),features:this.selection_,angle:h-this.angle_,pixel:e.pixel,coordinate:e.coordinate});break}case"translate":{var f=c[0]-o[0],v=c[1]-o[1];for(s=0,i;i=this.selection_.item(s);s++)i.getGeometry().translate(f,v);this.handles_.forEach(function(l){l.getGeometry().translate(f,v)}),this.coordinate_=e.coordinate,this.dispatchEvent({type:"translating",feature:this.selection_.item(0),features:this.selection_,delta:[f,v],pixel:e.pixel,coordinate:e.coordinate});break}case"scale":{var _=this.center_;if(this.get("modifyCenter")(e)){var m=this.extent_;this.get("enableRotatedTransform")&&t!==0&&(m=this.rotatedExtent_),_=m[(Number(this.opt_)+2)%4]}var g=this.geoms_.length==1&&this._isRectangle(this.geoms_[0]),F=this.constraint_,S=this.opt_,V=this.coordinate_,y=e.coordinate;if(this.get("enableRotatedTransform")&&t!==0){var A=new P(this.coordinate_);A.rotate(t*-1,_),V=A.getCoordinates();var U=new P(e.coordinate);U.rotate(t*-1,_),y=U.getCoordinates()}var w=(y[0]-_[0])/(V[0]-_[0]),p=(y[1]-_[1])/(V[1]-_[1]),u=[y[0]-V[0],y[1]-V[1]];if(this.get("enableRotatedTransform")&&t!==0){var I=new P(_);I.rotate(t*-1,this.getMap().getView().getCenter()),_=I.getCoordinates()}for(this.get("noFlip")&&(w<0&&(w=-w),p<0&&(p=-p)),this.constraint_?this.constraint_=="h"?w=1:p=1:this.get("keepAspectRatio")(e)&&(w=p=Math.min(w,p)),s=0,i;i=this.selection_.item(s);s++)n=t===0||!this.get("enableRotatedTransform")?this.geoms_[s].clone():this.rotatedGeoms_[s].clone(),n.applyTransform(function(l,a,M){if(M<2)return a;if(g){var G=[[6],[0,8],[2],[4]],d=[l[0],l[1]],T=[l[2],l[3]],R=[l[4],l[5]],E=[l[6],l[7]],L=[l[8],l[9]];if(F){var B=S%2===0?this._countVector(d,T):this._countVector(E,d),Z=this._projectVectorOnVector(u,B),H=S+1<G.length?S+1:0,K=[...G[S],...G[H]];for(r=0;r<l.length;r+=M)a[r]=K.includes(r)?l[r]+Z[0]:l[r],a[r+1]=K.includes(r)?l[r+1]+Z[1]:l[r+1]}else{var b,k;switch(S){case 0:u=this._countVector(E,y),b=this._projectVectorOnVector(u,this._countVector(R,E)),k=this._projectVectorOnVector(u,this._countVector(d,E)),[a[0],a[1]]=this._movePoint(d,b),[a[4],a[5]]=this._movePoint(R,k),[a[6],a[7]]=this._movePoint(E,u),[a[8],a[9]]=this._movePoint(L,b);break;case 1:u=this._countVector(d,y),b=this._projectVectorOnVector(u,this._countVector(E,d)),k=this._projectVectorOnVector(u,this._countVector(T,d)),[a[0],a[1]]=this._movePoint(d,u),[a[2],a[3]]=this._movePoint(T,b),[a[6],a[7]]=this._movePoint(E,k),[a[8],a[9]]=this._movePoint(L,u);break;case 2:u=this._countVector(T,y),b=this._projectVectorOnVector(u,this._countVector(d,T)),k=this._projectVectorOnVector(u,this._countVector(R,T)),[a[0],a[1]]=this._movePoint(d,k),[a[2],a[3]]=this._movePoint(T,u),[a[4],a[5]]=this._movePoint(R,b),[a[8],a[9]]=this._movePoint(L,k);break;case 3:u=this._countVector(R,y),b=this._projectVectorOnVector(u,this._countVector(T,R)),k=this._projectVectorOnVector(u,this._countVector(E,R)),[a[2],a[3]]=this._movePoint(T,k),[a[4],a[5]]=this._movePoint(R,u),[a[6],a[7]]=this._movePoint(E,b);break}}}else for(r=0;r<l.length;r+=M)w!=1&&(a[r]=_[0]+(l[r]-_[0])*w),p!=1&&(a[r+1]=_[1]+(l[r+1]-_[1])*p);return n.getType()=="Circle"&&n.setCenterAndRadius(n.getCenter(),n.getRadius()),a}.bind(this)),this.get("enableRotatedTransform")&&t!==0&&n.rotate(t,this.getMap().getView().getCenter()),i.setGeometry(n);this.drawSketch_(),this.dispatchEvent({type:"scaling",feature:this.selection_.item(0),features:this.selection_,scale:[w,p],pixel:e.pixel,coordinate:e.coordinate});break}}this.isUpdating_=!1}}handleMoveEvent_(e){if(!!this._handleEvent(e,this.features_)&&!this.mode_){var t=this.getFeatureAtPixel_(e.pixel),s=e.map.getTargetElement();if(t.feature){var r=t.handle?this.Cursors[(t.handle||"default")+(t.constraint||"")+(t.option||"")]:this.Cursors.select;this.previousCursor_===void 0&&(this.previousCursor_=s.style.cursor),s.style.cursor=r}else this.previousCursor_!==void 0&&(s.style.cursor=this.previousCursor_),this.previousCursor_=void 0}}handleUpEvent_(e){if(this.mode_==="rotate"){var t=e.map.getTargetElement();t.style.cursor=this.Cursors.default,this.previousCursor_=void 0}return this.dispatchEvent({type:this.mode_+"end",feature:this.selection_.item(0),features:this.selection_,oldgeom:this.geoms_[0],oldgeoms:this.geoms_}),this.drawSketch_(),this.mode_=null,!1}setPointRadius(e){typeof e=="function"?this._pointRadius=e:this._pointRadius=function(){return e}}getFeatures(){return this.selection_}_projectVectorOnVector(e,t){var s=(e[0]*t[0]+e[1]*t[1])/(t[0]*t[0]+t[1]*t[1]);return[t[0]*s,t[1]*s]}_countVector(e,t){return[t[0]-e[0],t[1]-e[1]]}_movePoint(e,t){return[e[0]+t[0],e[1]+t[1]]}};ie.prototype.Cursors={default:"auto",select:"pointer",translate:"move",rotate:"move",rotate0:"move",scale:"nesw-resize",scale1:"nwse-resize",scale2:"nesw-resize",scale3:"nwse-resize",scalev:"ew-resize",scaleh1:"ns-resize",scalev2:"ew-resize",scaleh3:"ns-resize"};export{ie as o};
